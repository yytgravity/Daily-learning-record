è®°å½•ä¸€ä¸‹è‡ªå·±æŒ–çš„ç¬¬ä¸€ä¸ªæ´ï¼Œè™½ç„¶æ˜¯ä¸ªç©ºæŒ‡é’ˆğŸ˜‚ï¼š
è¡¥ä¸ï¼šhttps://chromium-review.googlesource.com/c/chromium/src/+/2568818

```
void ClipboardPromise::OnReadAvailableFormatNames(
    const Vector<String>& format_names) {
  DCHECK_CALLED_ON_VALID_SEQUENCE(sequence_checker_);
  if (!GetExecutionContext())
    return;

  clipboard_item_data_.ReserveInitialCapacity(format_names.size()); //[1]
  for (const String& format_name : format_names) { //[2]
    clipboard_item_data_.emplace_back(format_name,
                                      /* Placeholder value. */ nullptr);
  }
  ReadNextRepresentation();
}
```
[1]å¤„å…ˆé¢„ç•™ä¸€å…±å¤šå°‘ä¸ªItemï¼ŒæŠŠtype-nullptrå¡«è¿›å»ã€‚[2]å¤„æŠŠnullptræ”¹æˆæ­£ç¡®çš„å€¼


```
void ClipboardPromise::ReadNextRepresentation() {
  DCHECK_CALLED_ON_VALID_SEQUENCE(sequence_checker_);
  if (!GetExecutionContext())
    return;
  if (clipboard_representation_index_ == clipboard_item_data_.size()) {
    ResolveRead();
    return;
  }

  String format_name =
      clipboard_item_data_[clipboard_representation_index_].first;
  if (is_raw_) {
    GetLocalFrame()->GetRawSystemClipboard()->Read(
        format_name,
        WTF::Bind(&ClipboardPromise::OnRawRead, WrapPersistent(this)));
    return;
  }

  ClipboardReader* clipboard_reader = ClipboardReader::Create(
      GetLocalFrame()->GetSystemClipboard(), format_name, this);
  if (!clipboard_reader) {
    OnRead(nullptr);
    return;
  }
  clipboard_reader->Read();
}
```
å¤åˆ¶vscodeçš„æ—¶å€™ä»–ä¸æ­¢æœ‰rtfï¼Œè¿˜æœ‰plainå’Œhtmlï¼Œåº”è¯¥æ˜¯å‰é¢ä¸¤ä¸ªå¯ä»¥åˆ°rtfä¸è¡Œäº†ï¼Œä½†ä»–å› ä¸ºæœ‰æˆåŠŸçš„æ‰€ä»¥éƒ½ä¼ ç»™writeäº†ï¼Œå°±æŠŠnullä¹Ÿä¼ è¿‡å»äº†ã€‚
![](./img/1.png)


ä¸‹é¢è®°å½•ä¸€ä¸‹è°ƒè¯•è¿‡ç¨‹ï¼š
é¦–å…ˆæ‰¾åˆ°crashä½ç½®ï¼š
```
void ClipboardPromise::HandleWriteWithPermission(PermissionStatus status) {
  DCHECK_CALLED_ON_VALID_SEQUENCE(sequence_checker_);
  if (!GetExecutionContext())
    return;
  if (status != PermissionStatus::GRANTED) {
    script_promise_resolver_->Reject(MakeGarbageCollected<DOMException>(
        DOMExceptionCode::kNotAllowedError, "Write permission denied."));
    return;
  }

  // Check that all blobs have valid types.
  for (const auto& type_and_blob : clipboard_item_data_) {
    String type = type_and_blob.first;
    String type_with_args = type_and_blob.second->type(); //[1] crash here!!!
    if (!ClipboardWriter::IsValidType(type, is_raw_)) {
      script_promise_resolver_->Reject(MakeGarbageCollected<DOMException>(
          DOMExceptionCode::kNotAllowedError,
          "Type " + type + " not supported on write."));
      return;
    }
    // For normal (not-raw) write, blobs may have a full MIME type with args
    // (ex. 'text/plain;charset=utf-8'), whereas the type must not have args
    // (ex. 'text/plain' only), so ensure that Blob->type is contained in type.
    // For raw clipboard, Blobs convert their type to lowercase.
    if (!type_with_args.Contains(type.LowerASCII())) {
      script_promise_resolver_->Reject(MakeGarbageCollected<DOMException>(
          DOMExceptionCode::kNotAllowedError,
          "Type " + type + " does not match the blob's type " +
              type_with_args));
      return;
    }
  }

  DCHECK(!clipboard_representation_index_);
  WriteNextRepresentation();
}
```
ç¨‹åºåœ¨String type_with_args = type_and_blob.second->type();å¤„å¥”æºƒã€‚
![](./img/2.png)

dataæ¥è‡ªäºä¼ å…¥çš„itemçš„æ‹·è´,å¦‚ä¸‹å›¾ï¼š
![](./img/3.png)

![](./img/6.png)
vectorå°±ç›´æ¥å’Œæ•°ç»„ä¸€æ ·ï¼Œmemberå°±è°ƒç”¨getrawå‡½æ•°ï¼Œç„¶åå»åˆ°clipitemåŸå§‹æŒ‡é’ˆä¹‹å
![](./img/7.png)
ä¼šè®¿é—®items_ï¼Œç„¶åè®¿é—®é‡Œé¢çš„Blobï¼Œç„¶åè®¿é—®é‡Œé¢çš„blob_data_handle_ï¼Œè¿™é‡Œé€šè¿‡æ‰“logæ¥æµ‹è¯•ä¸€ä¸‹ï¼šitems_copyåœ¨itemæœ€åˆæ‹·è´å‡ºæ¥çš„æ—¶å€™æœ‰æ²¡æœ‰å€¼ï¼Œå¦‚æœä»–æ­¤æ—¶ä¸ºnullï¼Œåˆ™éœ€è¦å›å»æ‰¾readçš„è¿‡ç¨‹ï¼Œæœ‰å€¼çš„è¯å°±ç»§ç»­è·Ÿwriteï¼ŒäºŒåˆ†æ³•æŒ–æ´ï¼Œxs
logå¦‚ä¸‹ï¼š
![](./img/4.png)
æµ‹è¯•å¾—åœ¨è¿™å°±æ˜¯ç©ºæŒ‡é’ˆäº†ï¼Œçœ‹ä¸‹å›¾å¯ä»¥å¾—çŸ¥writeçš„æ—¶å€™dataå°±å·²ç»æ˜¯ç©ºäº†ï¼Œæ‰€ä»¥å°±å»readæ‰¾é—®é¢˜ã€‚
![](./img/5.png)

ä¹‹åå°±æ‰¾åˆ°äº†é—®é¢˜æ‰€åœ¨ï¼Œä¹Ÿå°±æ˜¯æœ€å¼€å§‹çš„é‚£æ®µå†…å®¹ã€‚
